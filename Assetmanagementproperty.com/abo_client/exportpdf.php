<?php
 session_start(); include_once("config.php"); $conn = null; if (!tryConnect()) { die(); } require('fpdf/fpdf.php'); class PDF extends FPDF { function LoadData($file) { $lines = file($file); $data = array(); foreach($lines as $line) $data[] = explode("\t",trim($line)); return $data; } function FancyTable($header, $data) { $this->SetFillColor(255,0,0); $this->SetTextColor(255); $this->SetDrawColor(128,0,0); $this->SetLineWidth(.3); $this->SetFont('','B'); $w = 287 / count($header); for($i=0;$i<count($header);$i++) $this->Cell($w,7,$header[$i],1,0,'C',true); $this->Ln(); $this->SetFillColor(224,235,255); $this->SetTextColor(0); $this->SetFont(''); $fill = false; foreach($data as $row) { for($i=0; $i<count($row); ++$i) { $utf8row = mb_convert_encoding($row[$i], 'UTF-8', mb_detect_encoding($row[$i], 'UTF-8, ISO-8859-1', true)); $this->Cell($w,6,$utf8row,'LR',0,'L',$fill); } $this->Ln(); $fill = !$fill; } $this->Cell(287,0,'','T'); } } $table = @mysqli_real_escape_string($conn, $_GET["table"]); loadConfig(); loadAllCfg(); $type = @mysqli_real_escape_string($conn, $_GET["type"]); if ($type == 'view') { $db = $dbview; $cfgTables = $cfgView; } $pdf = new PDF('L','mm',array(297,210)); $pdf->SetMargins(5,5); $pdf->SetAutoPageBreak(true); $pdf->AddPage(); $pdf->SetAuthor('Auto Back Office'); $pdf->SetCreator('https://www.autobackoffice.com'); $k = array_keys($db[$table]); $names = []; for($i=0, $j=0; $i<count($k); $i++) { if ($db[$table][$k[$i]]["Status"] == 'Hidden') continue; if (@$cfgTables["multiuser_$table"] == $k[$i]) continue; $names[$j] = $k[$i]; $j++; } $f = ''; $header = []; for($i=0; $i<count($names); ++$i) { if (@$cfgTables["multiuser_$table"] == $names[$i]) continue; if ($db[$table][$names[$i]]["Status"]!='Hidden') $header[] = $names[$i]."\t"; } $f .= "\n"; $sql = "SELECT * FROM $table"; $result = $conn->query($sql); while($r = $result->fetch_array(MYSQLI_ASSOC)) { if (@$cfgTables["multiuser_$table"]) { $t = explode('/', @$cfgCustom["multiuserPrimary"]); $s = "SELECT `{$t[2]}` FROM {$t[0]} WHERE `{$t[1]}`='{$_SESSION['user']}'"; $multiUserId = @zbSQL($s); if ($multiUserId != $r[@$cfgTables["multiuser_$table"]]) continue; } for($i=0; $i<count($names); ++$i) if ($db[$table][$names[$i]]["Status"]!='Hidden') $f .= $r[$names[$i]]."\t"; $f .= "\n"; } $file = 'exportpdf.csv'; file_put_contents($file, "\xEF\xBB\xBF". $f); $data = $pdf->LoadData('exportpdf.csv'); $pdf->SetFont('Arial','',10); $pdf->FancyTable($header,$data); $pdf->Output(); ?>
