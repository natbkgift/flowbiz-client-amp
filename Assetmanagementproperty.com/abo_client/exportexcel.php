<?php
 session_start(); include_once("config.php"); $conn = null; if (!tryConnect()) { die(); } $table = @mysqli_real_escape_string($conn, $_GET["table"]); loadConfig(); loadAllCfg(); $type = @mysqli_real_escape_string($conn, $_GET["type"]); if ($type == 'view') { $db = $dbview; $cfgTables = $cfgView; } $k = array_keys($db[$table]); $names = []; for($i=0, $j=0; $i<count($k); $i++) { if ($db[$table][$k[$i]]["Status"] == 'Hidden') continue; if (@$cfgTables["multiuser_$table"] == $k[$i]) continue; $names[$j] = $k[$i]; $j++; } $f = ''; for($i=0; $i<count($names); ++$i) { if (@$cfgTables["multiuser_$table"] == $names[$i]) { continue; } if ($db[$table][$names[$i]]["Status"]!='Hidden') { $f .= escapeForCSV($names[$i]).","; } else { } } $f .= "\n"; $sql = "SELECT * FROM $table"; $result = $conn->query($sql); while($r = $result->fetch_array(MYSQLI_ASSOC)) { if (@$cfgTables["multiuser_$table"]) { $t = explode('/', @$cfgCustom["multiuserPrimary"]); $s = "SELECT `{$t[2]}` FROM {$t[0]} WHERE `{$t[1]}`='{$_SESSION['user']}'"; $multiUserId = @zbSQL($s); if ($multiUserId != $r[@$cfgTables["multiuser_$table"]]) continue; } for($i=0; $i<count($names); ++$i) { if ($db[$table][$names[$i]]["Status"]!='Hidden') $f .= escapeForCSV($r[$names[$i]]).","; } $f .= "\n"; } $file = 'exportexcel.csv'; file_put_contents($file, "\xEF\xBB\xBF". $f); if (file_exists($file)) { header('Content-Description: File Transfer'); header('Content-Type: application/octet-stream'); header('Content-Disposition: attachment; filename='.basename($file)); header('Content-Transfer-Encoding: binary'); header('Expires: 0'); header('Cache-Control: must-revalidate, post-check=0, pre-check=0'); header('Pragma: public'); header('Content-Length: ' . filesize($file)); ob_clean(); flush(); readfile($file); exit; } function escapeForCSV($value) { return '"' . str_replace('"', '""', $value) . '"'; } ?>
